require('dotenv').config();
const mongoose = require('mongoose');
const { Report } = require('../models');

async function checkRecentReports() {
  try {
    console.log('ğŸ”Œ Connecting to MongoDB...');
    await mongoose.connect(process.env.MONGODB_URI);
    console.log('âœ… Connected to MongoDB\n');

    // Get total count
    const totalReports = await Report.countDocuments();
    console.log(`ğŸ“Š Total Reports in Database: ${totalReports}\n`);

    // Get recent reports (last 30 days)
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    const recentReports = await Report.find({
      createdAt: { $gte: thirtyDaysAgo }
    })
      .populate('generated_by_employee_id', 'full_name email')
      .sort({ createdAt: -1 })
      .limit(50)
      .lean();

    console.log(`ğŸ“… Recent Reports (Last 30 Days): ${recentReports.length}\n`);

    // Check specifically for December 4-5, 2025 (accounting for timezone)
    // Try multiple date ranges to account for timezone differences
    const dec4StartUTC = new Date('2025-12-04T00:00:00.000Z');
    const dec5EndUTC = new Date('2025-12-06T00:00:00.000Z'); // Include full day of Dec 5
    
    // Also check with local timezone (UTC+4 for UAE)
    const dec4StartLocal = new Date('2025-12-03T20:00:00.000Z'); // Dec 4 00:00 UTC+4
    const dec5EndLocal = new Date('2025-12-05T20:00:00.000Z'); // Dec 6 00:00 UTC+4
    
    const decemberReports = await Report.find({
      $or: [
        { createdAt: { $gte: dec4StartUTC, $lt: dec5EndUTC } },
        { generatedAt: { $gte: dec4StartUTC, $lt: dec5EndUTC } },
        { createdAt: { $gte: dec4StartLocal, $lt: dec5EndLocal } },
        { generatedAt: { $gte: dec4StartLocal, $lt: dec5EndLocal } }
      ]
    })
      .populate('generated_by_employee_id', 'full_name email')
      .sort({ createdAt: -1 })
      .lean();

    console.log(`ğŸ“… Reports from December 4-5, 2025: ${decemberReports.length}\n`);
    
    if (decemberReports.length > 0) {
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ“‹ DECEMBER 4-5, 2025 REPORTS');
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
      
      decemberReports.forEach((report, index) => {
        console.log(`${index + 1}. Report ID: ${report._id}`);
        console.log(`   Title: ${report.title || 'N/A'}`);
        console.log(`   Generated By: ${report.generated_by_employee_id?.full_name || report.generated_by_employee_name || 'N/A'}`);
        console.log(`   Generated At: ${report.generatedAt ? new Date(report.generatedAt).toLocaleString() : 'N/A'}`);
        console.log(`   Created At: ${report.createdAt ? new Date(report.createdAt).toLocaleString() : 'N/A'}`);
        console.log(`   Created At (ISO): ${report.createdAt ? report.createdAt.toISOString() : 'N/A'}`);
        console.log('');
      });
    }
    
    // Also check all of December 2025
    const dec1Start = new Date('2025-12-01T00:00:00.000Z');
    const dec31End = new Date('2026-01-01T00:00:00.000Z');
    
    const allDecemberReports = await Report.find({
      $or: [
        { createdAt: { $gte: dec1Start, $lt: dec31End } },
        { generatedAt: { $gte: dec1Start, $lt: dec31End } }
      ]
    })
      .select('_id title createdAt generatedAt')
      .sort({ createdAt: -1 })
      .limit(100)
      .lean();
    
    console.log(`ğŸ“… All Reports from December 2025: ${allDecemberReports.length}\n`);
    
    if (allDecemberReports.length > 0) {
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ“‹ ALL DECEMBER 2025 REPORTS (Sample - First 20)');
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
      
      allDecemberReports.slice(0, 20).forEach((report, index) => {
        const createdDate = report.createdAt ? new Date(report.createdAt) : null;
        const generatedDate = report.generatedAt ? new Date(report.generatedAt) : null;
        console.log(`${index + 1}. ${report.title || 'Untitled'}`);
        console.log(`   ID: ${report._id}`);
        console.log(`   Created: ${createdDate ? createdDate.toLocaleString('en-US', { timeZone: 'UTC' }) : 'N/A'}`);
        console.log(`   Generated: ${generatedDate ? generatedDate.toLocaleString('en-US', { timeZone: 'UTC' }) : 'N/A'}`);
        console.log('');
      });
    }
    
    if (decemberReports.length > 0) {
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ“‹ DECEMBER 4-5, 2025 REPORTS');
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
      
      decemberReports.forEach((report, index) => {
        console.log(`${index + 1}. Report ID: ${report._id}`);
        console.log(`   Title: ${report.title || 'N/A'}`);
        console.log(`   Generated By: ${report.generated_by_employee_id?.full_name || report.generated_by_employee_name || 'N/A'}`);
        console.log(`   Generated At: ${report.generatedAt ? new Date(report.generatedAt).toLocaleString() : 'N/A'}`);
        console.log(`   Created At: ${report.createdAt ? new Date(report.createdAt).toLocaleString() : 'N/A'}`);
        
        // Show sample data keys
        if (report.report_data && typeof report.report_data === 'object') {
          const dataKeys = Object.keys(report.report_data).slice(0, 5);
          console.log(`   Data Keys: ${dataKeys.join(', ')}${Object.keys(report.report_data).length > 5 ? '...' : ''}`);
        }
        
        console.log('');
      });
    } else {
      console.log('â„¹ï¸  No reports found for December 4-5, 2025.\n');
    }

    if (recentReports.length > 0) {
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ“‹ RECENT REPORTS');
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

      recentReports.forEach((report, index) => {
        console.log(`${index + 1}. Report ID: ${report._id}`);
        console.log(`   Title: ${report.title || 'N/A'}`);
        console.log(`   Generated By: ${report.generated_by_employee_id?.full_name || report.generated_by_employee_name || 'N/A'}`);
        console.log(`   Generated At: ${report.generatedAt ? new Date(report.generatedAt).toLocaleString() : 'N/A'}`);
        console.log(`   Created At: ${report.createdAt ? new Date(report.createdAt).toLocaleString() : 'N/A'}`);
        
        // Check if it's an audit report
        const isAuditReport = report.title && (
          report.title.toLowerCase().includes('audit') ||
          report.title.toLowerCase().includes('historical')
        );
        
        if (isAuditReport) {
          console.log(`   âš ï¸  Type: AUDIT/HISTORICAL REPORT`);
        }
        
        // Show sample data keys
        if (report.report_data && typeof report.report_data === 'object') {
          const dataKeys = Object.keys(report.report_data).slice(0, 5);
          console.log(`   Data Keys: ${dataKeys.join(', ')}${Object.keys(report.report_data).length > 5 ? '...' : ''}`);
        }
        
        console.log('');
      });
    } else {
      console.log('â„¹ï¸  No reports found in the last 30 days.\n');
    }

    // Check for audit-specific reports
    const auditReports = await Report.find({
      $or: [
        { title: { $regex: /audit/i } },
        { title: { $regex: /historical/i } },
        { title: 'Historical Upload' }
      ]
    })
      .sort({ createdAt: -1 })
      .limit(10)
      .lean();

    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log(`ğŸ“‹ AUDIT/HISTORICAL REPORTS: ${auditReports.length} found`);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

    if (auditReports.length > 0) {
      auditReports.forEach((report, index) => {
        console.log(`${index + 1}. ${report.title || 'Untitled'}`);
        console.log(`   ID: ${report._id}`);
        console.log(`   Created: ${report.createdAt ? new Date(report.createdAt).toLocaleString() : 'N/A'}`);
        console.log(`   Generated: ${report.generatedAt ? new Date(report.generatedAt).toLocaleString() : 'N/A'}`);
        console.log('');
      });
    }

    // Summary
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ğŸ“Š SUMMARY');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log(`   Total Reports: ${totalReports}`);
    console.log(`   Recent Reports (30 days): ${recentReports.length}`);
    console.log(`   Audit/Historical Reports: ${auditReports.length}`);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

    process.exit(0);
  } catch (error) {
    console.error('âŒ Error checking reports:', error);
    process.exit(1);
  } finally {
    await mongoose.connection.close();
    console.log('ğŸ”Œ MongoDB connection closed');
  }
}

checkRecentReports();

